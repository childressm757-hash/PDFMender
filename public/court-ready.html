<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Court-Ready Processor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    h1 {
      margin-bottom: 20px;
    }
    button {
      padding: 8px 14px;
      margin-top: 10px;
      cursor: pointer;
    }
    #report {
      margin-top: 30px;
      padding: 20px;
      border: 1px solid #ccc;
      background: #f9f9f9;
    }
  </style>
</head>
<body>

  <h1>Run Before Filing</h1>

  <form id="uploadForm">
    <input type="file" name="file" accept="application/pdf" required />
    <br/>
    <button type="submit">Make Court-Ready</button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      const form = document.getElementById("uploadForm");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const existingReport = document.getElementById("report");
        if (existingReport) existingReport.remove();

        const formData = new FormData(form);

        try {
          const response = await fetch("/court/court-ready", {
            method: "POST",
            body: formData
          });

          if (!response.ok) {
            alert("Processing failed.");
            return;
          }

          const result = await response.json();

          const container = document.createElement("div");
          container.id = "report";

          let html = "<h2>Compliance Report</h2>";
          html += "<p><strong>Status:</strong> " + result.status + "</p>";

          if (result.detected && result.detected.length > 0) {
            html += "<h3>Detected Issues</h3><ul>";
            result.detected.forEach(d => {
              html += "<li><strong>" + d.issue + "</strong><br/>" + d.risk + "</li>";
            });
            html += "</ul>";
          }

          if (result.resolved && result.resolved.length > 0) {
            html += "<h3>Corrections Applied</h3><ul>";
            result.resolved.forEach(r => {
              html += "<li>" + r + "</li>";
            });
            html += "</ul>";
          }

          html += "<p><em>" + result.disclaimer + "</em></p>";

          html += '<button id="downloadBtn">Download Clean File</button>';

          container.innerHTML = html;
          document.body.appendChild(container);

          document.getElementById("downloadBtn").onclick = () => {
            window.location.href = result.download;
          };

        } catch (err) {
          console.error(err);
          alert("Unexpected error occurred.");
        }

      });

    });
  </script>

</body>
</html>
